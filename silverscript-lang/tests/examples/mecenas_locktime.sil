pragma silverscript ^0.12.0;

contract Mecenas(
    bytes20 recipient,
    bytes20 funder,
    int pledgePerBlock,
    bytes8 initialBlock,
) {
    function receive() {
        bytes25 recipientLockingBytecode = new LockingBytecodeP2PKH(recipient);
        require(tx.outputs[0].lockingBytecode == recipientLockingBytecode);

        int initial = int(initialBlock);
        require(tx.time >= initial);

        int passedBlocks = tx.locktime - initial;
        int pledge = passedBlocks * pledgePerBlock;

        int minerFee = 1000;
        int currentValue = tx.inputs[this.activeInputIndex].value;
        int changeValue = currentValue - pledge - minerFee;

        if (changeValue <= pledgePerBlock + minerFee) {
            require(tx.outputs[0].value == currentValue - minerFee);
        } else {
            require(tx.outputs[0].value == pledge);
            require(tx.outputs[1].value == changeValue);

            bytes bcValue = 8 + bytes8(tx.locktime) + this.activeBytecode.split(9)[1];
            bytes23 lockValue = new LockingBytecodeP2SH20(blake2b(bcValue));
            require(tx.outputs[1].lockingBytecode == lockValue);
        }
    }

    function reclaim(pubkey pk, sig s) {
        require(blake2b(pk) == funder);
        require(checkSig(s, pk));
    }
}
